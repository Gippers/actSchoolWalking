---
title: "Optimal New School Locations in 2024"
---

Analysis of where new schools should be built to minimize walking distances.

```{r setup}
#| echo: false
#| message: false
#| warning: false
library(sf)
library(leaflet)
library(dplyr)
library(htmltools)

# Load optimal location data
optimal_primary <- st_read(paste0(here::here(),"/data/new_schools/optimal_primary_location_2024.gpkg"), quiet = T)
optimal_high <- st_read(paste0(here::here(),"/data/new_schools/optimal_high_location_2024.gpkg"), quiet = T)

# Load 2024 walk time data for comparison
walk_2024 <- st_read(here::here("data", "walk_analysis", "school_walk_times_2024.gpkg"), quiet = TRUE)
primary_2024 <- walk_2024 |> filter(school_type == "primary")
high_2024 <- walk_2024 |> filter(school_type == "high")

# Create KPI callout function
create_kpi_callout <- function(title, value, subtitle, color = "#2166AC") {
  div(
    style = paste0("background-color: ", color, "; color: white; padding: 30px; 
                   border-radius: 12px; text-align: center; margin: 10px;"),
    h3(title, style = "margin: 0; font-size: 1.4em;"),
    h1(paste0(value, " mins"), 
       style = "margin: 10px 0; font-size: 3em; font-weight: bold;"),
    p(subtitle, 
      style = "margin: 0; font-size: 1.1em; opacity: 0.9;")
  )
}

# Create a focused map showing the proposed school location
create_school_location_map <- function(optimal_data, school_type, rank = 1) {
  # Get the optimal location
  test_school <- optimal_data[rank,]
     leaflet(test_school) |>
    addProviderTiles(providers$CartoDB.Positron) |>
       addMarkers(lng = ~longitude, lat = ~latitude) |>
       setView(lng = test_school$longitude, lat = test_school$latitude, zoom = 12)

}
```

# New Primary School Location
::: {.columns}

::: {.column width="60%"}

```{r}
#| echo: false
create_school_location_map(optimal_primary, "Primary", rank = 2)

```

:::

::: {.column width="40%"}

```{r}
#| echo: false
# Get values for rank 2 location
current_avg <- round(optimal_primary$current_avg_walk_time_min[2], 1)
projected_improvement <- round(optimal_primary$time_reduction_min[2], 2)
new_avg <- round(optimal_primary$new_avg_walk_time_min[2], 1)

# Current walk time KPI
create_kpi_callout(
  title = "Current Average (2024)", 
  value = current_avg,
  subtitle = "Population-weighted walk time to nearest primary school",
  color = "#dc2626"  # Red for current state
)
```

```{r}
#| echo: false
# Improved walk time KPI
create_kpi_callout(
  title = "With New School", 
  value = new_avg,
  subtitle = paste0("Improvement: -", projected_improvement, " minutes (", 
                   round((projected_improvement/current_avg)*100, 1), "% reduction)"),
  color = "#16a34a"  # Green for improvement
)
```

:::

::: 

# New High School Location
::: {.columns}

::: {.column width="60%"}

```{r}
#| echo: false
create_school_location_map(optimal_high, "High")

```

:::

::: {.column width="40%"}

```{r}
#| echo: false
# Get values for rank 1 location
current_avg <- round(optimal_high$current_avg_walk_time_min[1], 1)
projected_improvement <- round(optimal_high$time_reduction_min[1], 2)
new_avg <- round(optimal_high$new_avg_walk_time_min[1], 1)

# Current walk time KPI
create_kpi_callout(
  title = "Current Average (2024)", 
  value = current_avg,
  subtitle = "Population-weighted walk time to nearest high school",
  color = "#dc2626"  # Red for current state
)
```

```{r}
#| echo: false
# Improved walk time KPI
create_kpi_callout(
  title = "With New School", 
  value = new_avg,
  subtitle = paste0("Improvement: -", projected_improvement, " minutes (", 
                   round((projected_improvement/current_avg)*100, 1), "% reduction)"),
  color = "#16a34a"  # Green for improvement
)
```

:::

::: 