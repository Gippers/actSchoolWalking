---
title: "Canberra SA2 — School Aged Population Changes"
# This is a static HTML page — works on GitHub Pages
---


```{r}
# Load libraries and data
library(sf)
library(leaflet)
library(dplyr)
library(crosstalk)

erp <- st_read("data/erp_sa2.gpkg")

# TODO change later: For now only analyis 10-14 age group
# TODO change to 5-14 age group, aggregate
erp <- erp |>
    filter(age == "10-14")

# Rename erp column to value for consistency with mapping code
erp <- erp |>
    mutate(value = erp, metric = "Population 10-14")

# TODO create a proportion column for erp
```


## Population Map

```{r}
# Generated by Claude 3.5 Sonnet
# Simple approach - create individual leaflet maps for key years
library(leaflet)
library(htmltools)

# Create maps for key analysis years
key_years <- c(2001, 2010, 2020, 2024)

# Function to create a single leaflet map
create_leaflet_map <- function(year_selected) {
  data_yr <- erp |> filter(year == year_selected)
  
  # Calculate color palette for this year
  pal <- colorNumeric("viridis", data_yr$value, na.color = "#cccccc")
  
  leaflet(data_yr) |>
    addTiles() |>
    addPolygons(
      fillColor = ~pal(value),
      fillOpacity = 0.7,
      color = "#444444",
      weight = 1,
      label = ~paste0(sa2_name, ": ", value, " (", year, ")"),
      labelOptions = labelOptions(sticky = TRUE)
    ) |>
    addLegend(
      pal = pal, 
      values = ~value,
      title = paste("Population 10-14\n(", year_selected, ")")
    ) |>
    setView(lng = 149.12, lat = -35.30, zoom = 10)
}

# Create individual maps
maps_2001 <- create_leaflet_map(2001)
maps_2010 <- create_leaflet_map(2010) 
maps_2020 <- create_leaflet_map(2020)
maps_2024 <- create_leaflet_map(2024)

# Display maps with headers
tagList(
  h3("ACT School-Age Population Changes (10-14 years)"),
  h4("2001"), maps_2001,
  #h4("2010"), maps_2010,
  #h4("2020"), maps_2020,
  h4("2024"), maps_2024
)

```

# Change Map

```{r}
# Generated by Claude 3.5 Sonnet
# Updated map function with cleaner background tiles
create_leaflet_map <- function(year_selected) {
  data_yr <- erp |> filter(year == year_selected)
  
  # Calculate color palette for this year
  pal <- colorNumeric("viridis", data_yr$value, na.color = "#cccccc")
  
  leaflet(data_yr) |>
    # Option 1: Clean grayscale background
    addProviderTiles(providers$CartoDB.Positron) |>
    # Alternative options (uncomment one):
    # addProviderTiles(providers$CartoDB.PositronNoLabels) |>  # No street labels
    # addProviderTiles(providers$Stamen.TonerLite) |>          # Light toner
    # addProviderTiles(providers$Esri.WorldGrayCanvas) |>      # ESRI gray
    addPolygons(
      fillColor = ~pal(value),
      fillOpacity = 0.7,
      color = "#444444",
      weight = 1,
      label = ~paste0(sa2_name, ": ", value, " (", year, ")"),
      labelOptions = labelOptions(sticky = TRUE)
    ) |>
    addLegend(
      pal = pal, 
      values = ~value,
      title = paste("Population 10-14\n(", year_selected, ")")
    ) |>
    setView(lng = 149.12, lat = -35.30, zoom = 10)
}
```

```{r}
# Generated by Claude 3.5 Sonnet
# Create absolute change map with vibrant red-to-blue colors
create_change_map <- function() {
  # Get 2001 and 2024 data
  data_2001 <- erp |> filter(year == 2001) |> select(sa2_code, value_2001 = value)
  data_2024 <- erp |> filter(year == 2024) |> select(sa2_code, value_2024 = value, sa2_name, geom)
  
  # Calculate absolute change
  change_data <- data_2024 |>
    left_join(st_drop_geometry(data_2001), by = "sa2_code") |>
    mutate(
      change = value_2024 - value_2001,
      change_label = ifelse(change >= 0, paste0("+", change), as.character(change)),
      # Set opacity based on whether both values are 0
      fill_opacity = ifelse(value_2001 == 0 & value_2024 == 0, 0.3, 1.0)
    ) |>
    filter(!is.na(change))  # Remove areas with missing 2001 data
  
  # Create vibrant red-to-blue diverging palette
  max_abs_change <- max(abs(change_data$change), na.rm = TRUE)
  pal <- colorNumeric(
    palette = c("#B2182B", "#D6604D", "#F4A582", "#FDDBC7", "#D1E5F0", "#92C5DE", "#4393C3", "#2166AC"),
    domain = c(-max_abs_change, max_abs_change),
    na.color = "#cccccc"
  )
  
  leaflet(change_data) |>
    addProviderTiles(providers$CartoDB.Positron) |>  # Clean grayscale
    addPolygons(
      fillColor = ~pal(change),
      fillOpacity = ~fill_opacity,
      color = "#444444",
      weight = 1,
      label = ~paste0(
        sa2_name, "\n",
        "2001: ", value_2001, "\n", 
        "2024: ", value_2024, "\n",
        "Change: ", change_label
      ),
      labelOptions = labelOptions(sticky = TRUE)
    ) |>
    addLegend(
      position = "bottomright",
      pal = pal,
      values = ~change,
      title = "Population Change\n2001-2024\n(10-14 years)",
      labFormat = labelFormat(prefix = "", suffix = "")
    ) |>
    setView(lng = 149.12, lat = -35.30, zoom = 10)
}

# Create the change map
change_map <- create_change_map()

# Create the change map
change_map <- create_change_map()

# Display the change analysis
tagList(
  h3("ACT School-Age Population Change: 2001 to 2024"),
  h4("Absolute Change (Population 10-14 years)"), 
  change_map
)
```

Very clear trend that south canberra has lost a large portion of school aged children.

## TODO Population Change over Time Graph